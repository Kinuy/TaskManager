name: Mac Release

on:
  push:
    branches: 
      - 'main'
      - 'continuous-integration'
  pull_request:
    branches: 
      - 'main'
      - 'continuous-integration'

env:
  SOURCE_DIR:   ${{ github.workspace }}  
  QT_VERSION: 6.5.0
  CMAKE_VERSION: 3.21
  ARTIFACT:     task-manager-macos.zip

jobs:
  build:
    runs-on:  macos-latest

    steps:
      - name: (1) Checkout repo
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: (2) Get all tags for correct version determination
        working-directory:  ${{ github.workspace }}
        run: |
          git fetch --all --tags -f

      - name: (3) Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version:      ${{ env.QT_VERSION }}
          host:         mac
          target:       desktop
          arch:         clang_64
          dir:          ${{ runner.temp }}
          modules:      qtcharts qt3d
          setup-python: false

      - name: (4) Create build directory
        run:  mkdir -p ${{ runner.temp }}/build

      - name: (5) Build
        working-directory: ${{ runner.temp }}/build
        run:  |
              qmake -r ${{ env.SOURCE_DIR }}/planets-qml.pro
              make -j2
              
      - name: (7) Deploy Qt dependencies
        working-directory: ${{ runner.temp }}/build
        run:  |
              # Find the built executable (adjust path as needed for your CMake setup)
              find . -name "*.app" -type d | head -1 | xargs -I {} macdeployqt {} -qmldir=${{ env.SOURCE_DIR }} -dmg
              
      - name: (8) Zip build artifacts
        working-directory: ${{ runner.temp }}/build
        run:  |
              zip -r ../task-manager-macos.zip *.app *.dmg
              
      - name: (9) Save build artifact
        uses: actions/upload-artifact@main
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ runner.temp }}/${{ env.ARTIFACT }}