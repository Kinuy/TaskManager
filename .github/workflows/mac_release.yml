name: Mac Release

on:
  push:
    branches: 
      - 'main'
      - 'continuous-integration'
  pull_request:
    branches: 
      - 'main'
      - 'continuous-integration'

env:
  SOURCE_DIR:   ${{ github.workspace }}  
  QT_VERSION: 6.5.0
  CMAKE_VERSION: 3.21
  ARTIFACT:     task-manager-macos.zip

jobs:
  build:
    runs-on:  macos-latest

    steps:
      - name: (1) Checkout repo
        uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: (2) Get all tags for correct version determination
        working-directory:  ${{ github.workspace }}
        run: |
          git fetch --all --tags -f

      - name: (3) Install Qt via Homebrew
        run: |
          brew install qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV

      - name: (4) Configure CMake
        working-directory: ${{ runner.temp }}/build
        run: |
          cmake ${{ env.SOURCE_DIR }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)"

      - name: (5) Build
        working-directory: ${{ runner.temp }}/build
        run: cmake --build --parallel 2

      - name: (7) Deploy Qt dependencies
        working-directory: ${{ runner.temp }}/build
        run:  |
              # Find the built executable (adjust path as needed for your CMake setup)
              find . -name "*.app" -type d | head -1 | xargs -I {} macdeployqt {} -qmldir=${{ env.SOURCE_DIR }} -dmg
              
      - name: (8) Zip build artifacts
        working-directory: ${{ runner.temp }}/build
        run:  |
              zip -r ../task-manager-macos.zip *.app *.dmg
              
      - name: (9) Save build artifact
        uses: actions/upload-artifact@main
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ runner.temp }}/${{ env.ARTIFACT }}